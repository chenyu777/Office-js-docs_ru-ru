
# Создание надстройки SharePoint, содержащей шаблон документов и надстройку области задач


Вы можете создать надстройку SharePoint, которая включает в себя шаблон документа (например, авансовый отчет). Этот документ может содержать надстройку области задач, взаимодействующую с данными SharePoint. Например, пользователи могут заполнить поля счета, используя данные из Business Connectivity Services (BCS), или создать авансовый отчет, выбрав категорию расходов из списка SharePoint.

В этом пошаговом руководстве показано, как создать надстройку SharePoint, которая включает в себя книгу Excel. Книга Excel содержит надстройку области задач, использующую интерфейс REST, предоставленный SharePoint 2013, для заполнения поля раскрывающегося списка данными SharePoint.


## Необходимые условия


Установите следующие компоненты перед началом работы:




- Среда разработки SharePoint
    
      - To develop SharePoint Add-ins that target SharePoint in Office 365, see [How to: Set up an environment for developing SharePoint Add-ins on Office 365](http://msdn.microsoft.com/en-us/library/office/apps/fp161179%28v=office.15%29).
    
  - Инструкции по разработке надстроек SharePoint для локального сервера SharePoint см. в статье [Настройка локальной среды разработки надстроек SharePoint](http://msdn.microsoft.com/en-us/library/office/apps/fp179923%28v=office.15%29).
    
- [Visual Studio 2015 и Инструменты разработчика Microsoft Office](https://www.visualstudio.com/features/office-tools-vs)
    
- Excel 2013 или учетная запись Office 365.
    

## Создание проекта надстройки SharePoint в Visual Studio



1. Запустите Visual Studio.
    
2. В строке меню выберите пункты **Файл**, **Создать** и **Проект**.
    
    Откроется диалоговое окно **Создание проекта**.
    
3. Перейдите к области шаблонов и в узле необходимого языка разверните узел **Office/SharePoint**, затем выберите элемент **Office Add-ins** (Надстройки Office).
    
4. В списке типов проектов выберите элемент **Надстройка SharePoint**, назовите проект OfficeEnabledAddin и нажмите кнопку **ОК**.
    
    Откроется диалоговое окно **Создание надстройки SharePoint**.
    
5. В раскрывающемся списке **Какой сайт SharePoint использовать для отладки надстройки?** выберите или введите URL-адрес сайта SharePoint.
    
6. В раскрывающемся списке **Как разместить надстройку SharePoint?** выберите **Размещено в SharePoint** и нажмите кнопку **Далее**.
    
     >**Примечание**. Этот сценарий подходит только для вариантов размещения в SharePoint и у поставщика, указанных в раскрывающемся списке **Как требуется разместить надстройку SharePoint?**.
7. На следующей странице выберите **SharePoint 2013** и нажмите кнопку **Готово**, чтобы закрыть диалоговое окно.
    

## Добавление надстройки области задач


Затем добавьте в проект надстройку Office. Вы можете добавить надстройку любого типа. В этом руководстве мы добавим надстройку области задач.


1. В **обозревателе решений** выберите узел проекта **OfficeEnabledAddin**.
    
2. В меню **Проект** выберите пункт **Добавить новый элемент**.
    
3. В диалоговом окне **Добавление нового элемента** последовательно выберите элементы **Office/SharePoint** и **Надстройка Office**.
    
4. Назовите надстройку области задач MyTaskPaneAddin и нажмите кнопку **Добавить**.
    
    Откроется диалоговое окно **Создание надстройки для Office**.
    
5. В диалоговом окне **Создание надстройки для Office** выберите **Область задач** и нажмите кнопку **Далее**. На следующей странице снимите флажки **Word** и **PowerPoint** и нажмите кнопку **Далее**.
    
6. На странице **Добавить надстройку Office в новый или существующий документ?** выберите вариант **Создать документ и вставить надстройку** и нажмите кнопку **Готово**.
    
    Visual Studio добавляет библиотеку документов и шаблон книги для библиотеки. Книга содержит надстройку области задач.
    

## Добавление библиотеки документов


В этой процедуре необходимо добавить библиотеку документов и сделать книгу шаблоном по умолчанию для библиотеки документов.


1. В **обозревателе решений** выберите узел проекта **OfficeEnabledAddin**.
    
2. В меню **Проект** выберите пункт **Добавить новый элемент**.
    
3. В диалоговом окне **Добавление нового элемента** последовательно выберите элементы **Office/SharePoint** и **Список**. Назовите список MyDocumentLibrary и нажмите кнопку **Добавить**.
    
4. В **мастере настройки SharePoint** выберите параметр **Создать шаблон настраиваемого списка и отобразить его экземпляр в списке**.
    
5. В раскрывающемся списке под этим параметром выберите **Библиотека документов**, а затем нажмите кнопку **Далее**.
    
6. На странице **Выбор шаблона для библиотеки документов. Документы, создаваемые в библиотеке, будут основаны на этом шаблоне** выберите **Использовать следующий документ в качестве шаблона для библиотеки**, а затем нажмите кнопку **Обзор**.
    
7. В диалоговом окне **Открыть** откройте папку **OfficeDocuments**, выберите файл **MyTaskPaneApp.xlsx**, нажмите кнопку **Открыть**, затем нажмите кнопку **Готово** и закройте конструктор списка.
    
8. В **обозревателе решений** выберите узел проекта **OfficeEnabledAddin**.
    
9. В меню **Вид** выберите пункт **Окно свойств**.
    
10. В **обозревателе решений** выберите файл **AppManifest.xml**.
    
11. Выберите **Вид**, **Конструктор**.
    
12. В конструкторе манифестов задайте для элемента **Начальная страница** значение~~appWebUrl/Lists/MyDocumentLibrary. Оно будет преобразовано в значение OfficeEnabledAddin/Lists/MyDocumentLibrary.
    
     >**Примечание**. Этот URL-адрес относится к библиотеке документов. Следует использовать токен ~appWebUrl в начале любого URL-адреса в манифесте надстройки Office, который относится к элементам веб-сайта надстройки. Дополнительные сведения о токенах URL-адреса в проекте надстройки SharePoint см. в статье [Строки URL и маркеры в надстройках для SharePoint](http://msdn.microsoft.com/library/800ec8cd-a448-46bc-b41e-d4030eeb4048%28Office.15%29.aspx).
13. Закройте конструктор манифестов, чтобы сохранить изменения.
    

## Использование данных SharePoint в области задач


В этом разделе описано, как отобразить список пользователей сайта с помощью интерфейса REST, доступного в SharePoint 2013.

В этом примере отображаются только данные списка SharePoint, но вы можете использовать их в надстройке утверждения документа. Когда пользователь выбирает имя из этого списка, код устанавливает значение столбца "Рецензент" в списке отслеживания документа. Этому пользователю может быть отправлено уведомление о проверке. Кроме того, вы можете сохранить выбранное имя в параметрах документа. Тогда элементы управления в надстройке области задач будут отображаться, только если документ откроет пользователь, указанный в параметрах документа. Дополнительные сведения:


- [Выполнение базовых операций с использованием конечных точек REST SharePoint 2013](http://msdn.microsoft.com/library/e3000415-50a0-426e-b304-b7de18f2f7d9%28Office.15%29.aspx)
    
- [Выполнение базовых операций с использованием кода библиотеки JavaScript в SharePoint 2013](http://msdn.microsoft.com/library/29089af8-dbc0-49b7-a1a0-9e311f49c826%28Office.15%29.aspx)
    
- [Сохранение состояния и параметров надстройки](../../docs/develop/persisting-add-in-state-and-settings.md)
    

1. В **обозревателе решений** последовательно откройте папки **MyTaskPaneAddin** и **Home**, а затем выберите файл **Home.html**.
    
    Файл Home.html откроется в редакторе кода.
    
2. Добавьте следующий HTML-код под кнопкой `get-data-from-selection`.
    
```HTML
  <p>Select Reviewer:</p> <select class="select" id="select-reviewer" name="D1"> </select>
```

3. Выберите файл **Home.js**, чтобы открыть его в редакторе кода.
    
4. В начало файла Home.js добавьте следующие объявления.
    
```js
  var appWebURL; var web;
```

5. Замените функцию `Initialize` следующим кодом.
    
    Этот код выполняет такие задачи:
    
      - Загрузка файлов SP.Runtime.js и SP.js с помощью функции `getScript` в jQuery. После загрузки файлов программа получит доступ к объектной модели JavaScript для SharePoint.
    
  - Загрузка текущего объекта веб-сайта.
    
  - Вызов функции, получающей всех пользователей сайта. Код для этой функции будет добавлен на следующем этапе.
    



```js
   // The initialize function must be run each time a new page is loaded Office.initialize = function (reason) { $(document).ready(function () { app.initialize(); var scriptbase = "/_layouts/15/"; $.getScript(scriptbase + "SP.Runtime.js", function () { $.getScript(scriptbase + "SP.js", function () { getAppWeb(function () { getSPUsers(populateUsersDropDown); }); }); }); function getAppWeb(functionToExecuteOnReady) { var context = SP.ClientContext.get_current(); web = context.get_web(); context.load(web); context.executeQueryAsync(onSuccess, onFailure); function onSuccess() { appWebURL = web.get_url(); functionToExecuteOnReady(); } function onFailure(sender, args) { app.initialize(); app.showNotification("Failed to connect to SharePoint. Error: " + args.get_message()); } } $('#get-data-from-selection').click(getDataFromSelection); }); };
```

6. Добавьте следующий код в конец файла Home.js.
    
    Этот код служит для получения списка пользователей веб-сайта с помощью интерфейса REST, доступного в SharePoint 2013. Затем он заполняет раскрывающийся список именами и идентификаторами всех пользователей.
    


```js
  function getSPUsers(functionToExecuteOnReady) { var url = appWebURL + "/../_api/web/siteUsers"; jQuery.ajax({ url: url, type: "GET", headers: { "ACCEPT": "application/json;odata=verbose" }, success: onSuccess, error: onFailure }); function onSuccess(data) { var results = data.d.results; functionToExecuteOnReady(results); } function onFailure(jaXHR, textStatus, errorThrown) { var error = textStatus + " " + errorThrown; app.showNotification(error); } } function populateUsersDropDown(results) { for (var i = 0; i < results.length; i++) { var IDTemp = results[i].Id; $('#select-reviewer').append("<option value='" + IDTemp + "'>" + results[i].Title + "</option>"); } }
```

7. В **обозревателе решений** откройте контекстное меню для файла **AppManifest.xml** и выберите пункт **Конструктор представлений**.
    
8. В конструкторе перейдите на страницу **Разрешения**.
    
9. В раскрывающемся списке в столбце **Область** выберите элемент **Интернет**.
    
10. В раскрывающемся списке в столбце **Разрешения** выберите элемент **Чтение**.
    

## Отладка надстройки области задач


Чтобы отладить надстройку области задач, откройте документ или запустите надстройку SharePoint, а затем откройте документ из библиотеки документов.


### Отладка надстройки области задач с помощью открытия документа




 >**Примечание**. Так как эта процедура открывает Microsoft Excel, она работает только в том случае, если на компьютере установлен пакет Office. В противном случае возникает ошибка "Приложение, связанное с этим типом проекта, не установлено на компьютере".


1. Откройте файл Home.js в редакторе кода, а затем задайте точку останова рядом с методом `getDataFromSelection`.
    
2. В **обозревателе решений** выберите узел проекта **OfficeEnabledApp**.
    
3. В меню **Вид** выберите пункт **Окно свойств**.
    
4. В окне свойств в раскрывающемся списке **Действие при запуске** выберите элемент **Настольный клиент Office**. При этом появится новое свойство, **Документ при запуске**.
    
5. В раскрывающемся списке **Документ при запуске** выберите элемент **OfficeDocuments\TaskPaneApp.xlsx**.
    
6. В меню **Отладка** выберите команду **Начать отладку**.
    
    Это приведет к тому, что при запуске надстройки области задач в ней отобразится книга. Откроется книга, и появится надстройка области задач.
    
7. В надстройке области задач щелкните раскрывающийся список **Выбор рецензента**, чтобы просмотреть список пользователей SharePoint.
    
8. В книге Excel выберите любую ячейку.
    
9. В надстройке области задач нажмите кнопку **Получение данных из выделения**.
    
    Выполнение остановится в месте точки останова, указанной для метода `getDataFromSelection`.
    

### Отладка надстройки области задач с помощью запуска SharePoint




 >
  **Примечание** Эта процедура открывает Excel Online. Она работает только при наличии учетной записи Office 365. Инструкции см. в статье [Настройка среды для разработки надстроек SharePoint в Office 365](http://msdn.microsoft.com/en-us/library/office/apps/fp161179%28v=office.15%29).


1. Откройте файл Home.js в редакторе кода, а затем задайте точку останова рядом с методом `getDataFromSelection`.
    
2. В **обозревателе решений** выберите узел проекта **OfficeEnabledApp**.
    
3. В меню **Вид** выберите пункт **Окно свойств**.
    
4. В окне свойств в раскрывающемся списке **Действие при запуске** выберите элемент **Internet Explorer**.
    
5. В меню **Отладка** выберите команду **Начать отладку**.
    
    Visual Studio откроет SharePoint и отобразит библиотеку **MyDocumentLibrary**.
    
6. В SharePoint на вкладке **Файлы**, выберите команду **Создать документ**. 
    
7. Перейдите к книге в проекте MyTaskPaneApp.xlsx.
    
    Откроется книга, и появится надстройка области задач.
    
8. Проверьте, что в браузере включена отладка скриптов. Чтобы включить отладку в Internet Explorer, откройте диалоговое окно **Свойства обозревателя**, перейдите на вкладку **Дополнительно** и снимите флажки **Отключить отладку сценариев (Internet Explorer)** и **Отключить отладку сценариев (другие)**.
    
9. В Visual Studio откройте меню **Отладка** и выберите команду **Присоединиться к процессу**.
    
10. В диалоговом окне **Присоединение к процессу** выберите все доступные процессы **iexplore.exe**, а затем нажмите кнопку **Присоединиться**.
    
11. В надстройке области задач щелкните раскрывающийся список **Выбор рецензента**, чтобы просмотреть список пользователей SharePoint.
    
    Данные в списке извлекаются из SharePoint с помощью вызова REST.
    
12. В книге Excel выберите любую ячейку.
    
13. В надстройке области задач нажмите кнопку **Получение данных из выделения**.
    
    Выполнение остановится в месте точки останова, указанной для метода `getDataFromSelection`.
    
     >**Примечание**. Если книга не содержит данных, вы можете добавить их, выбрав элементы **Изменить книгу**, **Изменить в Excel Online** на панели инструментов в книге.

## Упаковка и публикация надстройки


Когда надстройка будет готова к упаковке для публикации, откройте мастер **публикации надстроек Office и SharePoint**.


- В **обозревателе решений** откройте контекстное меню для проекта надстройки SharePoint и выберите элемент **Опубликовать**.
    
    Откроется **мастер публикации надстроек для Office и SharePoint**. Дополнительные сведения см. в статье [Публикация надстройки для SharePoint с помощью Visual Studio](http://msdn.microsoft.com/library/8137d0fa-52e2-4771-8639-60af80f693bb%28Office.15%29.aspx).
    

## Дополнительные ресурсы


- [Рекомендации по проектированию надстроек Office](../../docs/design/add-in-design.md)
    
- [Жизненный цикл разработки надстроек Office](../../docs/design/add-in-development-lifecycle.md)
    
- [Публикация надстройки Office](../publish/publish.md)
    
- [Общие сведения об интерфейсе JavaScript API для Office](../../docs/develop/understanding-the-javascript-api-for-office.md)
    
- [XML-манифест надстроек для Office](../../docs/overview/add-in-manifests.md)
    
- [Ссылки на интерфейс API и схему надстроек для Office](../../reference/reference.md)
    
