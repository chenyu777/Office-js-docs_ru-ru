
# Использование регулярных правил активации выражений для отображения надстройки Outlook

Вы можете создать правила на основе регулярных выражений, чтобы активировать надстройку Outlook в сценариях чтения, когда пользователь просматривает сообщение или сведения о встрече в области чтения или инспекторе, Outlook оценивает правила регулярных выражений и определяет целесообразность активации надстройки. Outlook не оценивает эти правила при создании элементов. Существуют и другие элементы, для которых Outlook не активирует надстройки, например элементы, защищенные с помощью управления правами на доступ к данным (IRM) или находящиеся в папке нежелательной почты. Дополнительные сведения см. в разделе [Правила активации для надстроек Outlook](../outlook/manifests/activation-rules.md).

Вы можете задать регулярное выражение как часть правила [ItemHasRegularExpressionMatch](http://msdn.microsoft.com/en-us/library/bfb726cd-81b0-a8d5-644f-2ca90a5273fc%28Office.15%29.aspx) или [ItemHasKnownEntity](http://msdn.microsoft.com/en-us/library/87e10fd2-eab4-c8aa-bec3-dff92d004d39%28Office.15%29.aspx) в XML-файле манифеста надстройки. Outlook вычисляет регулярные выражения на основании правил для интерпретатора JavaScript, используемых браузером на клиентском компьютере. Outlook поддерживает тот же список специальных символов, что и все обработчики XML. Эти специальные символы перечислены в приведенной ниже таблице. В ней также показано, как можно использовать их в регулярном выражении, указывая escape-последовательность для соответствующего символа.



|**Знак**|**Описание**|**Используемая escape-последовательность**|
|:-----|:-----|:-----|
|"|Двойная кавычка|&amp;quot;|
|&amp;|Амперсанд|&amp;amp;|
|'|Апостроф|&amp;apos;|
|<|Знак "меньше"|&amp;lt;|
|>|Знак "больше"|&amp;gt;|

## Правило ItemHasRegularExpressionMatch


Правило **ItemHasRegularExpressionMatch** удобно использовать для управления активацией надстройки на основе определенных значений поддерживаемого свойства. Атрибуты для правила **ItemHasRegularExpressionMatch** указаны ниже.



|**Имя атрибута**|**Описание**|
|:-----|:-----|
|**RegExName**|Указывает имя регулярного выражения, чтобы вы могли сослаться на него в коде надстройки.|
|**RegExValue**|Указывает регулярное выражение, которое будет рассчитано для определения необходимости отображения надстройки.|
|**PropertyName**|Задает имя свойства, для которого будет вычисляться регулярное выражение. Разрешены следующие значения: **BodyAsHTML**, **BodyAsPlaintext**, **SenderSMTPAddress** и **Subject**. Если вы указываете **BodyAsHTML**, Outlook применяет регулярное выражение только в том случае, когда телом элементе является HTML-код, в противном случае Outlook не возвращает соответствий для данного регулярного выражения. Поскольку встречи сохраняются в формате RTF, регулярное выражение, указывающее **BodyAsHTML**, не соответствует никаким строкам в теле элементов встреч. Если вы указываете **BodyAsPlaintext**, Outlook всегда применяет регулярное выражение для тела элемента.|
|**IgnoreCase**|Указывает, следует ли игнорировать регистр при сравнении регулярного выражения, заданного **RegExName**.|

### Рекомендации по использованию регулярных выражений в правилах

При использовании регулярных выражений уделяйте особое внимание следующим аспектам:


- Если вы указываете правило **ItemHasRegularExpressionMatch** для тела элемента, регулярное выражение должно обеспечить дополнительную фильтрацию телу и не должно пытаться возвратить тело элемента целиком. Попытка получить полное тело элемента путем задания такого регулярного выражения, как `.*`, не всегда дает ожидаемые результаты.
    
- Тело обычного текста, возвращенное в одном браузере, может иметь малозаметные отличия от этого же тела, возвращенного в другом браузере. Если вы используете правило [ItemHasRegularExpressionMatch](http://msdn.microsoft.com/en-us/library/bfb726cd-81b0-a8d5-644f-2ca90a5273fc%28Office.15%29.aspx) с **BodyAsPlaintext** в качестве атрибута **PropertyName**, протестируйте регулярное выражение во всех браузерах, поддерживаемых вашей надстройкой.
    
    Так как в разных браузерах основной текст выбранного элемента считывается разными способами, ваше регулярное выражение должно учитывать мелкие различия, которые могут быть возвращены в составе основного текста. К примеру, в некоторых браузерах, таких как Internet Explorer 9, для получения основного текста элемента используется свойство **innerText** модели DOM, а в других (например, Firefox) — метод **.textContent()**. Кроме того, различные браузеры могут по-разному возвращать разрывы строк (в Internet Explore — "\r\n", а в Firefox и Chrome — "\n"). Дополнительные сведения см. в документе [Консорциум W3C: совместимость с моделью DOM (HTML)](http://www.quirksmode.org/dom/w3c_html.mdl#t07).
    
- Существуют незначительные отличия между основным текстом HTML элемента расширенного клиента Outlook, Outlook Web App и OWA для устройств. Тщательно задавайте регулярные выражения. В качестве примера рассмотрите следующее регулярное выражение, используемое в правиле **ItemHasRegularExpressionMatch** с **BodyAsHTML** в качестве значения атрибута **PropertyName**:
    
```
      http.*\.contoso\.com
```


    A rule with this regular expression would match the string "http-equiv="Content-Type" which exists in the HTML body of an item in an Outlook rich client, as part of the following  **META** tag:
    

```HTML
      <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=us-ascii">
```


В Outlook Web App и Outlook Web App для устройств одно и то же правило не возвращает такое совпадение, так как текст HTML в этих ведущих приложениях не содержит тег **META**. Это может оказать негативное влияние на активацию надстройки для различных клиентов Outlook. Вместо этого используйте следующее регулярное выражение из данного примера:
    

```
      http://.*\.contoso\.com/
```

- В зависимости от ведущего приложения, типа устройства или свойства, к которому применяется регулярное выражение, существуют рекомендации и ограничения для каждого ведущего приложения, которые следует учитывать в качестве правил активации при составлении регулярных выражений. Дополнительные сведения см. в статье [Ограничения для активации и API JavaScript для надстроек Outlook](../outlook/limits-for-activation-and-javascript-api-for-outlook-add-ins.md).
    

### Примеры

Следующее правило **ItemHasRegularExpressionMatch** активирует надстройку, если SMTP-адрес отправителя содержит строку "@contoso" без учета регистра.


```XML
<Rule xsi:type="ItemHasRegularExpressionMatch" 
    RegExName="addressMatches" 
    RegExValue="@[cC][oO][nN][tT][oO][sS][oO]" 
    PropertyName="SenderSMTPAddress"
/>
```

Ниже приведен другой способ указания того же регулярного выражения с использованием атрибута **IgnoreCase**.




```XML
<Rule xsi:type="ItemHasRegularExpressionMatch" 
    RegExName="addressMatches" 
    RegExValue="@contoso" 
    PropertyName="SenderSMTPAddress"
    IgnoreCase="true"
/>
```

Следующее правило **ItemHasRegularExpressionMatch** активирует надстройку, если основной текст текущего элемента содержит биржевой символ акции.




```XML
<Rule xsi:type="ItemHasRegularExpressionMatch" 
    PropertyName="BodyAsPlaintext" 
    RegExName="TickerSymbols" 
    RegExValue="\b(NYSE|NASDAQ|AMEX):\s*[A-Za-z]+\b"/>

```


## Правило ItemHasKnownEntity


Правило **ItemHasKnownEntity** активирует надстройку при наличии сущности в теме или основном тексте выбранного элемента. Поддерживаемые сущности определяет тип [KnownEntityType](http://msdn.microsoft.com/en-us/library/432d413b-9fcc-eb50-cfea-0ed10a43bd52%28Office.15%29.aspx). Применение регулярного выражения для правила **ItemHasKnownEntity** обеспечивает удобство, так как активация выполняется с учетом подмножества значений для сущности (например, конкретного набора URL-адресов или номеров телефонов с определенным кодом города).


 >
  **Примечание**  Независимо от языка и региональных параметров, указанных в манифесте, Outlook может извлекать строки сущностей только на английском языке. Тип сущности  **MeetingSuggestion** поддерживается только сообщениями, а встречи его не поддерживают.Извлечь сущности из элементов в папке "Отправленные" невозможно, как и использовать правило [ItemHasKnownEntity](http://msdn.microsoft.com/en-us/library/87e10fd2-eab4-c8aa-bec3-dff92d004d39%28Office.15%29.aspx), чтобы активировать надстройку для элементов в этой папке.

Правило **ItemHasKnownEntity** поддерживает атрибуты, перечисленные в следующей таблице. Обратите внимание на то, что хотя в правиле **ItemHasKnownEntity** указание регулярного выражения не является обязательным, в случае использования регулярного выражения в качестве фильтра сущностей следует указать как атрибут **RegExFilter**, так и атрибут **FilterName**.



|**Имя атрибута**|**Описание**|
|:-----|:-----|
|**EntityType**|Указывает тип сущности, которую требуется найти, чтобы расчет правила давал значение **true**. Используйте несколько правил, чтобы указать несколько типов сущностей.|
|**RegExFilter**|Указывает регулярное выражение, обеспечивающее дальнейшую фильтрацию экземпляров сущности, указанной атрибутом  **EntityType**.|
|**FilterName**|Указывает имя регулярного выражения, заданного атрибутом  **RegExFilter**, чтобы впоследствии можно было сослаться на него в коде.|
|**IgnoreCase**|Указывает, следует ли игнорировать регистр при сравнении регулярного выражения, заданного **RegExFilter**.|

### Примеры

Следующее правило **ItemHasKnownEntity** активирует надстройку, если в основном тексте или теме текущего элемента присутствует URL-адрес, содержащий строку "youtube" без учета регистра.


```XML
<Rule xsi:type="ItemHasKnownEntity" 
    EntityType="Url" 
    RegExFilter="youtube"
    FilterName="youtube"
    IgnoreCase="true"/>
```


## Использование результатов регулярных выражений в коде


Вы можете получить соответствия регулярному выражению, воспользовавшись следующими методами текущего элемента:


- [getRegExMatches](../../reference/outlook/Office.context.mailbox.item.md) возвращает совпадения в текущем элементе для всех регулярных выражений, указанных в правилах **ItemHasRegularExpressionMatch** и **ItemHasKnownEntity** надстройки.
    
- [getRegExMatchesByName](../../reference/outlook/Office.context.mailbox.item.md) возвращает сведения о совпадениях в текущем элементе для определенного регулярного выражения, указанного в правиле **ItemHasRegularExpressionMatch** надстройки.
    
- [getFilteredEntitiesByName](../../reference/outlook/Office.context.mailbox.item.md) возвращает полные экземпляры сущностей, которые содержат совпадения для определенного регулярного выражения, указанного в правиле **ItemHasKnownEntity** надстройки.
    
При вычислении регулярных выражений сведения о совпадениях возвращаются в надстройку в виде объекта массива. Для **getRegExMatches** этот объект имеет идентификатор имени регулярного выражения. 


 >**Примечание**  Полнофункциональный клиент Outlook не возвращает сведения о совпадениях в массив в определенном порядке. Кроме того, не следует предполагать, что этот клиент Outlook возвратит в этот массив сведения о совпадениях в том же порядке, что и Outlook Web App или OWA для устройств, даже если вы запускаете одну и ту же надстройку в каждом из этих клиентов для одного и того же элемента в одном и том же почтовом ящике. Сведения о различиях в обработке регулярных выражений в полнофункциональном клиенте Outlook и Outlook Web App или OWA для устройств см. в статье [Ограничения для активации и API JavaScript для надстроек Outlook](../outlook/limits-for-activation-and-javascript-api-for-outlook-add-ins.md).


### Примеры

Ниже приведен пример коллекции правил, содержащей правило **ItemHasRegularExpressionMatch** с регулярным выражением `videoURL`.


```XML
<Rule xsi:type="RuleCollection" Mode="And">
    <Rule xsi:type="ItemIs" ItemType="Message"/>
    <Rule xsi:type="ItemHasRegularExpressionMatch" RegExName="VideoURL" RegExValue="http://www\.youtube\.com/watch\?v=[a-zA-Z0-9_-]{11}" PropertyName="Body"/>
</Rule>
```

В следующем примере **getRegExMatches** текущего элемента используется, чтобы задать для переменной `videos` результаты предыдущего правила **ItemHasRegularExpressionMatch**.




```
var videos = Office.context.mailbox.item.getRegExMatches().videoURL;
```

несколько совпадений хранятся в этом объекте в виде элементов массива. Следующий пример кода показывает, как выполнять итерацию по совпадениям для регулярного выражения `reg1`, чтобы создать строку для отображения в виде HTML-кода.




```js
function initDialer() 
{
    var myEntities;
    var myString;
    var myCell;
    myEntities = _Item.getRegExMatches();

    myString = "";
    myCell = document.getElementById('dialerholder');
    // Loop over the myEntities collection.
    for (var i in myEntities.reg1) {
        myString += "<p><a href='callto:tel:" + myEntities.reg1[i] + "'>" + myEntities.reg1[i] + "</a></p>";
    }
    myCell.innerHTML = myString;
}

```

Ниже приведен пример правила  **ItemHasKnownEntity**, которое указывает сущность  **MeetingSuggestion** и регулярное выражение `CampSuggestion`. Outlook активирует надстройку, если выбранный в данный момент элемент содержит приглашение на встречу, а тема или основной текст содержат термин "WonderCamp".




```XML
<Rule xsi:type="ItemHasKnownEntity" 
    EntityType="MeetingSuggestion"
    RegExFilter="WonderCamp"
    FilterName="CampSuggestion"
    IgnoreCase="false"/>
```

В следующем примере кода  **getFilteredEntitiesByName(name)** текущего элемента используется, чтобы задать для переменной `suggestions` получение массива обнаруженных предложений о встрече для предыдущего правила **ItemHasKnownEntity**.




```
var suggestions = Office.context.mailbox.item.getFilteredEntitiesByName(CampSuggestion);
```


## Дополнительные ресурсы



- [Создание надстроек Outlook для форм чтения](../outlook/read-scenario.md)
    
- [Правила активации для надстроек Outlook](../outlook/manifests/activation-rules.md)
    
- [Ограничения активации и API JavaScript для надстроек Outlook](../outlook/limits-for-activation-and-javascript-api-for-outlook-add-ins.md)
    
- [Сопоставление строк в элементе Outlook как известных сущностей](../outlook/match-strings-in-an-item-as-well-known-entities.md)
    
- [Рекомендации по использованию регулярных выражений в .NET Framework](http://msdn.microsoft.com/en-us/library/618e5afb-3a97-440d-831a-70e4c526a51c%28Office.15%29.aspx)
    
